From d0f215f69e1e8ebe27441c8bd8e32363ad305e22 Mon Sep 17 00:00:00 2001
From: Ilya Fedin <fedin-ilja2010@ya.ru>
Date: Tue, 12 Apr 2022 02:55:23 +0400
Subject: [PATCH] FileChooser portal: set current_name

Fixes: QTBUG-100297
Change-Id: I5d41e01aafeccce2d886debdb595b4c87b03a043
Reviewed-by: Jan Grulich <jgrulich@redhat.com>
Reviewed-by: Thiago Macieira <thiago.macieira@intel.com>
(cherry picked from commit 974a7bd6e0ece921e699df6c2b346f944f723b83)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../xdgdesktopportal/qxdgdesktopportalfiledialog.cpp       | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/plugins/platformthemes/xdgdesktopportal/qxdgdesktopportalfiledialog.cpp b/src/plugins/platformthemes/xdgdesktopportal/qxdgdesktopportalfiledialog.cpp
index 66e374f6211..22873974ebe 100644
--- a/src/plugins/platformthemes/xdgdesktopportal/qxdgdesktopportalfiledialog.cpp
+++ b/src/plugins/platformthemes/xdgdesktopportal/qxdgdesktopportalfiledialog.cpp
@@ -48,6 +48,7 @@
 
 #include <QEventLoop>
 #include <QFile>
+#include <QFileInfo>
 #include <QMetaType>
 #include <QMimeType>
 #include <QMimeDatabase>
@@ -199,8 +200,12 @@ void QXdgDesktopPortalFileDialog::openPortal()
         if (!d->directory.isEmpty())
             options.insert(QLatin1String("current_folder"), QFile::encodeName(d->directory).append('\0'));
 
-        if (!d->selectedFiles.isEmpty())
+        if (!d->selectedFiles.isEmpty()) {
+            // current_file for the file to be pre-selected, current_name for the file name to be pre-filled
+            // current_file accepts absolute path while current_name accepts just file name
             options.insert(QLatin1String("current_file"), QFile::encodeName(d->selectedFiles.first()).append('\0'));
+            options.insert(QLatin1String("current_name"), QFileInfo(d->selectedFiles.first()).fileName());
+        }
     }
 
     // Insert filters
