From 96d0e04a6ce72f3a3a3ee782f39fecc33aef9739 Mon Sep 17 00:00:00 2001
From: Ilya Fedin <fedin-ilja2010@ya.ru>
Date: Thu, 26 Jan 2023 18:44:16 +0400
Subject: [PATCH] Revert "D-Bus system tray: properly check whether
 StatusNotifierHost available"

This reverts commit 23e9b57e3d261f66168a8a28ccb8e5c886b4841f.

Change-Id: Ic3e4a9c2d6db00299ed1f2b14043c4b675fb8ccc
---
 src/gui/platform/unix/dbusmenu/qdbusmenuconnection.cpp | 10 +++++-----
 src/gui/platform/unix/dbusmenu/qdbusmenuconnection_p.h |  4 ++--
 src/gui/platform/unix/dbustray/qdbustrayicon.cpp       |  7 +++++--
 src/gui/platform/unix/qgenericunixthemes.cpp           |  2 +-
 4 files changed, 13 insertions(+), 10 deletions(-)

diff --git a/src/gui/platform/unix/dbusmenu/qdbusmenuconnection.cpp b/src/gui/platform/unix/dbusmenu/qdbusmenuconnection.cpp
index 9391b77f6a..1023b16662 100644
--- a/src/gui/platform/unix/dbusmenu/qdbusmenuconnection.cpp
+++ b/src/gui/platform/unix/dbusmenu/qdbusmenuconnection.cpp
@@ -40,14 +40,14 @@ QDBusMenuConnection::QDBusMenuConnection(QObject *parent, const QString &service
     , m_connection(serviceName.isNull() ? QDBusConnection::sessionBus()
                                         : QDBusConnection::connectToBus(QDBusConnection::SessionBus, serviceName))
     , m_dbusWatcher(new QDBusServiceWatcher(StatusNotifierWatcherService, m_connection, QDBusServiceWatcher::WatchForRegistration, this))
-    , m_statusNotifierHostRegistered(false)
+    , m_watcherRegistered(false)
 {
 #ifndef QT_NO_SYSTEMTRAYICON
-    QDBusInterface systrayHost(StatusNotifierWatcherService, StatusNotifierWatcherPath, StatusNotifierWatcherService, m_connection);
-    if (systrayHost.isValid() && systrayHost.property("IsStatusNotifierHostRegistered").toBool())
-        m_statusNotifierHostRegistered = true;
+    // Start monitoring if any known tray-related services are registered.
+    if (m_connection.interface()->isServiceRegistered(StatusNotifierWatcherService))
+        m_watcherRegistered = true;
     else
-        qCDebug(qLcMenu) << "StatusNotifierHost is not registered";
+        qCDebug(qLcMenu) << "failed to find service" << StatusNotifierWatcherService;
 #endif
 }
 
diff --git a/src/gui/platform/unix/dbusmenu/qdbusmenuconnection_p.h b/src/gui/platform/unix/dbusmenu/qdbusmenuconnection_p.h
index 69713b12bd..37033e2fa3 100644
--- a/src/gui/platform/unix/dbusmenu/qdbusmenuconnection_p.h
+++ b/src/gui/platform/unix/dbusmenu/qdbusmenuconnection_p.h
@@ -39,7 +39,7 @@ public:
     ~QDBusMenuConnection();
     QDBusConnection connection() const { return m_connection; }
     QDBusServiceWatcher *dbusWatcher() const { return m_dbusWatcher; }
-    bool isStatusNotifierHostRegistered() const { return m_statusNotifierHostRegistered; }
+    bool isWatcherRegistered() const { return m_watcherRegistered; }
 #ifndef QT_NO_SYSTEMTRAYICON
     bool registerTrayIconMenu(QDBusTrayIcon *item);
     void unregisterTrayIconMenu(QDBusTrayIcon *item);
@@ -60,7 +60,7 @@ private:
     QString m_serviceName;
     QDBusConnection m_connection;
     QDBusServiceWatcher *m_dbusWatcher;
-    bool m_statusNotifierHostRegistered;
+    bool m_watcherRegistered;
 };
 
 QT_END_NAMESPACE
diff --git a/src/gui/platform/unix/dbustray/qdbustrayicon.cpp b/src/gui/platform/unix/dbustray/qdbustrayicon.cpp
index 18334e5715..5be223b510 100644
--- a/src/gui/platform/unix/dbustray/qdbustrayicon.cpp
+++ b/src/gui/platform/unix/dbustray/qdbustrayicon.cpp
@@ -331,8 +331,11 @@ void QDBusTrayIcon::notificationClosed(uint id, uint reason)
 bool QDBusTrayIcon::isSystemTrayAvailable() const
 {
     QDBusMenuConnection * conn = const_cast<QDBusTrayIcon *>(this)->dBusConnection();
-    qCDebug(qLcTray) << conn->isStatusNotifierHostRegistered();
-    return conn->isStatusNotifierHostRegistered();
+
+    // If the KDE watcher service is registered, we must be on a desktop
+    // where a StatusNotifier-conforming system tray exists.
+    qCDebug(qLcTray) << conn->isWatcherRegistered();
+    return conn->isWatcherRegistered();
 }
 
 QT_END_NAMESPACE
diff --git a/src/gui/platform/unix/qgenericunixthemes.cpp b/src/gui/platform/unix/qgenericunixthemes.cpp
index 1efd759bcf..638f5e41a0 100644
--- a/src/gui/platform/unix/qgenericunixthemes.cpp
+++ b/src/gui/platform/unix/qgenericunixthemes.cpp
@@ -77,7 +77,7 @@ static bool isDBusTrayAvailable() {
     static bool dbusTrayAvailableKnown = false;
     if (!dbusTrayAvailableKnown) {
         QDBusMenuConnection conn;
-        if (conn.isStatusNotifierHostRegistered())
+        if (conn.isWatcherRegistered())
             dbusTrayAvailable = true;
         dbusTrayAvailableKnown = true;
         qCDebug(qLcTray) << "D-Bus tray available:" << dbusTrayAvailable;
-- 
2.38.1

